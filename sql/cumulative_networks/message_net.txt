select
  'message' as edge_type,
  cf.*,
  avg_weight,
  if(nodes*(nodes-1)/2=0, 0, edges/(nodes*(nodes-1)/2))*100 as network_density_X_100,
  2*edges/nodes as avg_degree,
  avg_indegree,
  avg_outdegree,
  (avg_indegree - avg_outdegree) / avg_outdegree indegree_skew
from `community_networks.community_facts` cf 
join 
  (select m_community_id cid, count(distinct(conversation.id)) edges
  from vs_reporting.user_memberships u
  join `hipyard_analytics_production.message_events_partitioned` m on u.user_id = m.sender.id
  group by cid) e on cf.cid = e.cid
join 
  (select cid, avg(edge_weight) avg_weight
  from
    (select m_community_id cid, conversation.id edge, count(distinct(timestamp)) edge_weight
    from vs_reporting.user_memberships u
    join `hipyard_analytics_production.message_events_partitioned` m on u.user_id = m.sender.id
    group by cid, edge)
  group by cid) w on w.cid = cf.cid
join
  (select cid, avg(indeg) avg_indegree
  from
    (select m_community_id cid, recipient_id, count(distinct(timestamp)) indeg
    from vs_reporting.user_memberships u
    join
      (select recipient.id recipient_id, sender.id sender_id, id
      from `hipyard_analytics_production.message_events_partitioned`) t on u.user_id = t.sender.id
    group by cid, recipient_id)
  group by cid) indegree on indegree.cid = cf.cid
join
  (select cid, avg(outdeg) avg_outdegree
  from
    (select m_community_id cid, sender_id, count(distinct(timestamp)) outdeg
    from vs_reporting.user_memberships u
    join
      (select recipient.id recipient_id, sender.id sender_id, id
      from `hipyard_analytics_production.message_events_partitioned`) t on u.user_id = t.sender.id
    group by cid, sender_id)
  group by cid) outdegree on outdegree.cid = cf.cid
where nodes > 100
order by cid
